## nginx负载均衡和反向代理的配置与优化

​         随着网站访问量的快速增长，单台服务器已经无法承担大量用户的并发访问，必须采用多台服务器协同工作，以提高计算机系统的处理能力和计算高度，满足当前业务量的需求。而如何在完成同样功能的多个网络设备之间实现合理的业务分配，使之不会出现一天设备过忙，而其他的设备却没有充分使用的情况。要解决这一问题，可以采用负载均衡的方法。

### 负载均衡

​        负载均衡是由多台服务器组成的一个服务器集合，每台服务器都具有等价的地位，都可以单独的对外提供服务而无需其他服务器的辅助。通过某种负载分担技术，将外部发送来的请求均匀分配到某一台服务器上，而接收到请求的服务器独立的回应客户的请求，负载均衡能够平均的分配客户请求到服务器阵列，藉此快速获取重要数据，解决大量并发访问服务问题。这种集群技术可以用最少的 投资获得接近于大型主机的性能。

#### 常见负载均衡方式

##### 手动选择

![1573741838122](assets\1573741838122.png)

比较传统的方式，通过提供不同的现路不同服务器连接的方式实现负载均衡。这种方式在提供下载业务的网站中比较常见。

##### DNS轮询方式   域名服务商   

简单说就是给域名配多个服务器地址，当解析域名的时候会被随机解析到其中一个IP上，从而实现负载均衡的目的。

虽然DNS轮询成本低廉，但是，DNS负载均衡存在两个明显的缺点。

1. 可靠性低
2. 负载分配不均衡

ISO    国际     OSI  网络七层/四层  轮询   大公司在使用的,花费比较高

##### nginx负载均衡

1.可靠性高

2.负载均衡默认是1:2:3，可以设置请求的比例，可以设置权重

3.免费  小公司使用nginx    

### 反向代理

![1573788698548](assets\1573788698548.png)

​         反向代理（Reverse Proxy）是以代理服务器来接受Internet上的连接请求，然后将请求转发给内部网络上的服务器，并将从服务器上得到的结果返回给Internet上请求连接的客户端，此时代理服务器对外表现为一个服务器。

#### nginx负载均衡反向代理服务器配置

```shell
user www-data;
worker_processes auto; 
pid /run/nginx.pid; 
events{
        worker_connections 768;
# multi_accept on; 
} 
http{ 
        upstream myapp1 {
                server 192.168.137.81:8081 weight=1;
                server 192.168.137.81:8082 weight=1;
                server 192.168.137.81:8083 weight=2;
        }
        server{
                listen 80;
                location / {
                        proxy_pass http://myapp1;
                }
        }
} 
```

在我们的http服务中主要有两个模块，一个是upstream模块，一个是server模块。我们来详细的看看这两个模块有哪些功能。

##### upstream模块

upstream模块是负载均衡的主要模块，它提供了一个简单方法来实现轮询和客户端IP之间的后端服务器负载均衡，并可以对后端服务器进行健康检查。示例如下：

```shell
http{ 
        upstream myapp1 {
                server 192.168.137.81:8081 weight=1;
                server 192.168.137.81:8082 weight=1;
                server 192.168.137.81:8083 weight=2;
        }
} 
```

+ ip_hash命令

  解决问题：session存储，session共享

  可能会遇到的问题：如果对应的服务器挂掉，session同样没有，而且破坏了负载均衡

  示例代码如下:

  ```shell
  http{ 
  ip_hash;
          upstream myapp1 {
                  server 192.168.137.81:8081 weight=1;
                  server 192.168.137.81:8082 weight=1;
                  server 192.168.137.81:8083 weight=2;
          }
  } 
  ```

+ Server命令

  + weight

  + max_fails

    设置错误次数

  + fail_timeout

  + down

    表示永久关机

  + backup

    备份

  ```shell
  http{ 
  ip_hash;
          upstream myapp1 {
                  server 192.168.137.81:8081 weight=1  down;
                  server 192.168.137.81:8082 weight=1  max_fails=3  fail_timeout=30s;
                  server 192.168.137.81:8083 weight=2;
          }
  } 
  ```

## 双机热备

![1573789226585](assets\1573789226585.png)